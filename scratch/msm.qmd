---
title: "Untitled"
format: html
---

```{r}
#options(repos = c(CRAN = "http://cran.rstudio.com"))
library(msm)
library(tidyverse)

set.seed(0)
cav <- cav %>% mutate(obstype = sample(c(1,2), nrow(.), replace = TRUE)) # mix of panel and exactly observed data
readr::write_csv(cav, "scratch/cav.csv")

Q_ind <- matrix(# need connections between states 1 and 3.
    c(0,1,1,1,
      1,0,1,1,
      1,1,0,1,
      0,0,0,0),
    nrow = 4, byrow = TRUE)
Q0 <- crudeinits.msm(state ~ years, PTNUM, data = cav, qmatrix = Q_ind)
m_mixed_12 <- msm(state ~ years, PTNUM, data = cav, qmatrix = Q0, obstype = obstype)
print(m_mixed_12)
```

```{julia}
using MultistateModels
using CSV

cav = CSV.read("scratch/cav.csv", DataFrame)

subjids = unique(cav.PTNUM)
nsubj = length(subjids)

cav_startstop = DataFrame(
    id=zeros(0),
    tstart=zeros(0),
    tstop=zeros(0),
    statefrom=zeros(0),
    stateto=zeros(0),
    obstype=zeros(0),
    sex=zeros(0)
)

for subjid in subjids

    # subject data
    cav_subj = filter(row -> row.PTNUM == subjid, cav)
    n_obs    = nrow(cav_subj) # number of observations

    tstart    = cav_subj.years[1:n_obs-1] # remove last time
    tstop     = cav_subj.years[2:n_obs  ] # remove first time
    statefrom = cav_subj.state[1:n_obs-1]
    stateto   = cav_subj.state[2:n_obs  ]
    obstype   = cav_subj.obstype[2:n_obs  ] # obstype value for the first observation from each subject is not used

    # start-stop format
    n_trans = n_obs - 1 # number of transitions
    append!(
        cav_startstop,
        DataFrame(
            id = fill(subjid, n_trans),
            tstart=tstart,
            tstop=tstop,
            statefrom=statefrom,
            stateto=stateto,
            obstype=obstype,
            sex=fill(cav_subj.sex[1], n_trans)
            )
        )
end

h12 = Hazard(@formula(0 ~ 1), "exp", 1, 2)
h21 = Hazard(@formula(0 ~ 1), "exp", 2, 1)
h13 = Hazard(@formula(0 ~ 1), "exp", 1, 3)
h31 = Hazard(@formula(0 ~ 1), "exp", 3, 1)
h14 = Hazard(@formula(0 ~ 1), "exp", 1, 4)
h41 = Hazard(@formula(0 ~ 1), "exp", 4, 1)
h23 = Hazard(@formula(0 ~ 1), "exp", 2, 3)
h32 = Hazard(@formula(0 ~ 1), "exp", 3, 2)
h24 = Hazard(@formula(0 ~ 1), "exp", 2, 4)
h42 = Hazard(@formula(0 ~ 1), "exp", 4, 2)
h34 = Hazard(@formula(0 ~ 1), "exp", 3, 4)
h43 = Hazard(@formula(0 ~ 1), "exp", 4, 3)

m = multistatemodel(h12, h21, h13, h31, h14, h41, h23, h32, h24, h42, h34, h43; data = cav_startstop)

h12 = Hazard(@formula(0 ~ 1), "exp", 1, 2)
h21 = ParametricHazard(@formula(0 ~ 1), "exp", 2, 1)

dat = 
    DataFrame(id = repeat(collect(1:100), inner = 2),
              tstart = repeat([0.0,5.0], outer = 100),
              tstop = repeat([5.0,10.0], outer = 100),
              statefrom = fill(1, 200),
              stateto = fill(2, 200),
              obstype = fill(1, 200))

msm_2state_trans = multistatemodel(h12, h21, h13, h31, h14, h41, h23, h32, h24, h42, h34, h43; data = dat)


```